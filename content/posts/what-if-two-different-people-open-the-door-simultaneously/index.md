---
title: "兩個人同時開一個門會怎麼樣？"
date: 2021-06-12T11:02:02+08:00
draft: false
math: true
---
## 破題

不，魚不是想討論一般情況下開門的問題，在《異世界食堂》動畫作品中，魚看到了一個彈幕：
> 「要是有兩個異世界人同時打開門會怎麼樣？」

在《異世界食堂》的世界觀中，每當禮拜六在異世界的各處就會出現通往「洋食のねこや」之門。開了這扇門就能進入
日本的「洋食のねこや」料理屋。那麼食堂只有一個，但傳送門有很多個，那麼若使彈幕中的問題有意義的話，更準確的表述應該是：如果有多個異世界人同時打開**不同**的門會怎樣？

## 怎樣？

在全片中沒有出現過問題中的情況，也沒有解釋這種情況。當然作品中從沒發生過和概率爲零是兩個不同的概念。
那麼有什麼辦法可以解釋這個現象或者解決這個問題呢？首先定義一下什麼叫同時打開門，兩個開門事件在同時發生的概率爲
$0$ , 因爲一個時刻在數軸上是一個點，傳送門出現的時間是週六一天$24$小時。那麼，我們不妨把一次從開門事件到關門事件的過程稱爲一個**開放區間**，兩個開放區間有重疊稱爲同時打開門。那麼問題就是，如何處理兩個不同的開放區間可能重疊的問題。

那麼矛盾在哪裏呢？在動畫畫面中可以看到，在從食堂朝向外面的畫面中，我們可以知道在食堂中是能直接看到外界的，同時也有從外向內的畫面，那麼可知的是，開門過程是不能有阻塞的。

### 概率

要解決這個問題，最簡單的就是讓兩個開放區間不可能重疊，即令異世界中所有的事物構成一個精密的系統，如波函數坍塌一般，當一個門被打開，則其他的門被打開的概率變爲 $0$，不是指門打不開，而是指在異世界中根本不可能有人去開其他門，通過某種魔法或者猶未可知的機理（畢竟傳送門就已經夠魔幻了）

### 緩衝區

首先給出結論：使用任何形式的 `channel`，包括 `std::sync::mpsc` 和 `chan` 都是不行的。因爲真實世界中所要求的是絕對的同時。而使用 `channel` 時，`channel` 同時只能發送一個物件，其他的發送會被阻塞。因此是無法解決問題的。

那如果使用帶緩衝區的信道呢？當進入門後都先被傳送入一個佇列（可能是一片魔法空間）中，稱其爲 Buffer，然後遵循 FIFO 的過程，當門被關上時則將 Buffer 中下一位顧客傳入，而且因爲是異世界不需要考慮緩衝區大小的問題。這麼雖然可行，但是顯然不符合作品設定，因此也 PASS.

### 互斥鎖

魚認爲最有意思也是最現實的就是使用互斥鎖（Mutex）了。顯然的，在動畫畫面中傳送門上也是存在門鎖的。那麼只需要作很小的設定就可以解決這個問題：當一個開門的上升沿（大概位於門把手被轉下去的時刻），互斥鎖會被上鎖，然後其他地方的傳送門就不能再次爲 Mutex 上鎖，從而即使壓下門把手也不能打開門，就如同門鎖被物理地鎖上了一樣。當門被關上後，Mutex 被解鎖，其他的門就可以再次打開了。

同時魚注意到了，在動畫中人餐後離開食堂關上門後，門就會消失掉。這裏可以設定爲門被析構的同時 Mutex 被解鎖，就像 `std::sync::Mutex` 一樣.

---

所有的內容都是魚突發奇想，請不要認真:)